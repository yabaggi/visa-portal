<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --primary: #1a56db; --primary-dark: #1e40af; --primary-light: #dbeafe;
      --success: #059669; --success-light: #d1fae5;
      --warning: #d97706; --warning-light: #fef3c7;
      --danger: #dc2626; --danger-light: #fee2e2;
      --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
      --gray-300: #d1d5db; --gray-500: #6b7280; --gray-700: #374151; --gray-900: #111827;
      --radius: 12px;
      --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
      --shadow-lg: 0 10px 15px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.05);
    }

    html, body {
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y pan-x;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--gray-50); color: var(--gray-900); line-height: 1.6;
    }

    html[dir="rtl"] body { font-family: 'Segoe UI', Tahoma, 'Cairo', 'Noto Sans Arabic', sans-serif; }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white; padding: 16px 16px 14px; text-align: center;
      box-shadow: var(--shadow-md);
    }

    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .header h1 { font-size: 20px; font-weight: 700; flex: 1; }
    .header p { font-size: 13px; opacity: 0.9; }

    .lang-toggle {
      background: rgba(255,255,255,0.2); border: 1.5px solid rgba(255,255,255,0.4);
      color: white; padding: 6px 14px; border-radius: 20px; font-size: 13px;
      font-weight: 600; cursor: pointer; white-space: nowrap;
    }

    .nav-tabs {
      display: flex; background: white; border-bottom: 1px solid var(--gray-200);
      box-shadow: var(--shadow);
    }

    .nav-tab {
      flex: 1; padding: 14px 8px; text-align: center; font-size: 14px; font-weight: 600;
      color: var(--gray-500); border: none; background: none; cursor: pointer;
      border-bottom: 3px solid transparent; touch-action: manipulation;
    }

    .nav-tab.active { color: var(--primary); border-bottom-color: var(--primary); background: var(--primary-light); }
    .nav-tab svg { display: block; margin: 0 auto 4px; pointer-events: none; }

    .container { max-width: 600px; margin: 0 auto; padding: 16px; }
    .section { display: none; }
    .section.active { display: block; }

    .card {
      background: white; border-radius: var(--radius); padding: 20px;
      margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid var(--gray-200);
    }

    .card-title {
      font-size: 16px; font-weight: 700; margin-bottom: 16px; padding-bottom: 12px;
      border-bottom: 2px solid var(--primary-light); display: flex; align-items: center; gap: 8px;
    }

    .card-title .icon {
      width: 32px; height: 32px; border-radius: 8px; background: var(--primary-light);
      display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0;
    }

    .form-group { margin-bottom: 16px; }
    .form-group.hidden { display: none; }

    .form-group label {
      display: block; font-size: 13px; font-weight: 600;
      color: var(--gray-700); margin-bottom: 6px;
    }

    .form-group label .required { color: var(--danger); margin-inline-start: 2px; }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 12px 14px; border: 1.5px solid var(--gray-300);
      border-radius: 8px; font-size: 16px; color: var(--gray-900); background: white;
      -webkit-appearance: none; touch-action: manipulation;
    }

    html[dir="rtl"] .form-group input,
    html[dir="rtl"] .form-group select,
    html[dir="rtl"] .form-group textarea { text-align: right; }

    html[dir="rtl"] .form-group input[type="date"],
    html[dir="rtl"] .form-group input[type="email"],
    html[dir="rtl"] .form-group input[type="tel"] { text-align: left; direction: ltr; }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26,86,219,0.15);
    }

    .form-group input.error, .form-group select.error, .form-group textarea.error {
      border-color: var(--danger); box-shadow: 0 0 0 3px rgba(220,38,38,0.1);
    }

    .form-group .error-msg { color: var(--danger); font-size: 12px; margin-top: 4px; display: none; }
    .form-group .error-msg.show { display: block; }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    .photo-upload {
      border: 2px dashed var(--gray-300); border-radius: var(--radius);
      padding: 24px; text-align: center; cursor: pointer; background: var(--gray-50);
      touch-action: manipulation;
    }

    .photo-upload:hover { border-color: var(--primary); background: var(--primary-light); }
    .photo-upload.has-photo { border-style: solid; border-color: var(--success); background: var(--success-light); }
    .photo-upload img { max-width: 120px; max-height: 150px; border-radius: 8px; margin-bottom: 8px; }

    .step-indicators { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; }

    .step-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--gray-300); }
    .step-dot.active { background: var(--primary); transform: scale(1.3); }
    .step-dot.completed { background: var(--success); }

    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      padding: 14px 24px; border: none; border-radius: 8px; font-size: 15px;
      font-weight: 600; cursor: pointer; width: 100%; touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-primary:disabled { background: var(--gray-300); cursor: not-allowed; }
    .btn-outline { background: white; color: var(--primary); border: 2px solid var(--primary); }

    .btn-row { display: flex; gap: 12px; margin-top: 20px; }
    .btn-row .btn { flex: 1; }

    .alert {
      padding: 14px 16px; border-radius: 8px; font-size: 14px; margin-bottom: 16px;
      display: flex; align-items: flex-start; gap: 10px;
    }

    .alert-success { background: var(--success-light); color: #065f46; border: 1px solid #a7f3d0; }
    .alert-error { background: var(--danger-light); color: #991b1b; border: 1px solid #fecaca; }
    .alert-info { background: var(--primary-light); color: #1e40af; border: 1px solid #bfdbfe; }

    .track-card {
      background: white; border-radius: var(--radius); padding: 24px;
      text-align: center; box-shadow: var(--shadow); border: 1px solid var(--gray-200);
    }

    .track-result {
      margin-top: 20px; padding: 20px; border-radius: var(--radius); border: 1px solid var(--gray-200);
      text-align: start;
    }

    .status-badge { display: inline-block; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; }
    .status-Pending { background: var(--warning-light); color: #92400e; }
    .status-Under-Review { background: var(--primary-light); color: #1e40af; }
    .status-Approved { background: var(--success-light); color: #065f46; }
    .status-Rejected { background: var(--danger-light); color: #991b1b; }

    .info-row {
      display: flex; justify-content: space-between; padding: 10px 0;
      border-bottom: 1px solid var(--gray-100); font-size: 14px;
    }

    .info-row:last-child { border-bottom: none; }
    .info-label { color: var(--gray-500); font-weight: 500; }
    .info-value { font-weight: 600; color: var(--gray-900); }

    .spinner {
      display: inline-block; width: 20px; height: 20px;
      border: 3px solid rgba(255,255,255,0.3); border-radius: 50%;
      border-top-color: white; animation: spin 0.8s ease infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: center;
    }

    .overlay.show { display: flex; }

    .modal {
      background: white; border-radius: var(--radius); padding: 32px 24px;
      margin: 16px; max-width: 400px; width: 100%; text-align: center; box-shadow: var(--shadow-lg);
    }

    .modal .check-icon {
      width: 64px; height: 64px; border-radius: 50%; background: var(--success-light);
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 16px; font-size: 32px;
    }

    .modal h2 { font-size: 20px; margin-bottom: 8px; }
    .modal p { color: var(--gray-500); font-size: 14px; margin-bottom: 8px; }

    .app-id-box {
      background: var(--gray-100); padding: 12px; border-radius: 8px;
      font-family: monospace; font-size: 16px; font-weight: 700;
      color: var(--primary); margin: 16px 0; word-break: break-all;
      display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap;
    }

    .copy-btn {
      background: var(--primary); color: white; border: none; border-radius: 6px;
      padding: 6px 14px; font-size: 13px; font-weight: 600; cursor: pointer;
      display: inline-flex; align-items: center; gap: 4px; white-space: nowrap;
      touch-action: manipulation;
    }

    .copy-btn.copied { background: var(--success); }

    .home-hero { text-align: center; padding: 32px 16px; }
    .home-hero .hero-icon { font-size: 56px; margin-bottom: 16px; }
    .home-hero h2 { font-size: 22px; margin-bottom: 8px; }
    .home-hero p { color: var(--gray-500); font-size: 14px; margin-bottom: 24px; }

    .feature-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }

    .feature-card {
      background: white; border-radius: var(--radius); padding: 20px 16px;
      text-align: center; box-shadow: var(--shadow); border: 1px solid var(--gray-200);
      cursor: pointer; touch-action: manipulation;
    }

    .feature-card .feat-icon { font-size: 28px; margin-bottom: 8px; }
    .feature-card h3 { font-size: 14px; font-weight: 600; }
    .feature-card p { font-size: 12px; color: var(--gray-500); margin-top: 4px; }

    .required-note { font-size: 12px; color: var(--gray-500); margin-bottom: 16px; }
    .required-note .required { color: var(--danger); }

    .loading-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: white; z-index: 300; justify-content: center; align-items: center;
      flex-direction: column; gap: 16px;
    }

    .loading-overlay.show { display: flex; }

    .loading-spinner {
      width: 40px; height: 40px; border: 4px solid var(--gray-200);
      border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite;
    }

    @media (max-width: 400px) {
      .form-row { grid-template-columns: 1fr; }
      .container { padding: 12px; }
    }
  </style>
</head>
<body>
    
    <!-- HOME BUTTON -->
<div id="homeBar" style="background:#1e293b;padding:10px 16px;display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:9999;">
  <button onclick="goToLanding()" style="display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);color:#fff;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.3s;">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
    Home
  </button>
  <span style="color:rgba(255,255,255,0.4);font-size:13px;">Visa Request Portal</span>
</div>

  <div class="loading-overlay show" id="loadingScreen">
    <div class="loading-spinner"></div>
    <div style="color:var(--gray-500);font-size:14px;" data-i18n="loadingPortal">Loading portal...</div>
  </div>

  <div id="mainApp" style="display:none;">

  <div class="header">
    <div class="header-top">
      <div style="width:60px;"></div>
      <h1 data-i18n="headerTitle">ğŸŒ Visa Request Portal</h1>
      <button class="lang-toggle" onclick="toggleLang()" id="langBtn">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
    </div>
    <p data-i18n="headerSub">Submit and track your visa application</p>
  </div>

  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showSection('home')">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      <span data-i18n="navHome">Home</span>
    </button>
    <button class="nav-tab" onclick="showSection('apply')">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      <span data-i18n="navApply">Apply</span>
    </button>
    <button class="nav-tab" onclick="showSection('track')">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <span data-i18n="navTrack">Track</span>
    </button>
  </div>

  <!-- HOME -->
  <div id="section-home" class="section active">
    <div class="container">
      <div class="home-hero">
        <div class="hero-icon">âœˆï¸</div>
        <h2 data-i18n="heroTitle">Welcome to Visa Services</h2>
        <p data-i18n="heroSub">Apply for your visa online with our simple, secure process.</p>
      </div>
      <div class="feature-grid">
        <div class="feature-card" onclick="showSection('apply')">
          <div class="feat-icon">ğŸ“</div><h3 data-i18n="featNewApp">New Application</h3><p data-i18n="featNewAppDesc">Start your visa request</p>
        </div>
        <div class="feature-card" onclick="showSection('track')">
          <div class="feat-icon">ğŸ”</div><h3 data-i18n="featTrack">Track Status</h3><p data-i18n="featTrackDesc">Check your application</p>
        </div>
        <div class="feature-card">
          <div class="feat-icon">ğŸ“‹</div><h3 data-i18n="featReqs">Requirements</h3><p data-i18n="featReqsDesc">View what you need</p>
        </div>
        <div class="feature-card">
          <div class="feat-icon">â“</div><h3 data-i18n="featFaq">Help & FAQ</h3><p data-i18n="featFaqDesc">Get answers fast</p>
        </div>
      </div>
      <div class="card">
        <div class="card-title"><div class="icon">ğŸ“Œ</div> <span data-i18n="importantInfo">Important Information</span></div>
        <div style="font-size:14px;color:var(--gray-700);">
          <p style="margin-bottom:8px;" data-i18n="info1">âœ… Passport must be valid 3-6 months beyond intended stay</p>
          <p style="margin-bottom:8px;" data-i18n="info2">âœ… Recent passport-size photograph required</p>
          <p style="margin-bottom:8px;" data-i18n="info3">âœ… All mandatory fields must be completed accurately</p>
          <p data-i18n="info4">âœ… Save your Application ID to track your status</p>
        </div>
      </div>
    </div>
  </div>

  <!-- APPLICATION FORM -->
  <div id="section-apply" class="section">
    <div class="container">
      <div class="step-indicators" id="stepIndicators"></div>
      <div id="formAlert"></div>
      <form id="visaForm" onsubmit="return false;">
        <div id="formStepsContainer"></div>
      </form>
    </div>
  </div>

  <!-- TRACK -->
  <div id="section-track" class="section">
    <div class="container">
      <div class="track-card">
        <div style="font-size:48px;margin-bottom:16px;">ğŸ”</div>
        <h2 style="font-size:18px;margin-bottom:4px;" data-i18n="trackTitle">Track Your Application</h2>
        <p style="font-size:14px;color:var(--gray-500);margin-bottom:20px;" data-i18n="trackSub">Enter your Application ID to check the status</p>
        <div class="form-group" style="text-align:start;">
          <input type="text" id="trackId" placeholder="e.g. VIS-2026-ABCD1234" style="text-align:center;font-weight:600;">
        </div>
        <button class="btn btn-primary" onclick="trackApp()" data-i18n="btnTrack">Track Application</button>
        <div id="trackResult"></div>
      </div>
    </div>
  </div>

  </div>

  <!-- SUCCESS MODAL -->
  <div class="overlay" id="successModal">
    <div class="modal">
      <div class="check-icon">âœ…</div>
      <h2 data-i18n="modalTitle">Application Submitted!</h2>
      <p data-i18n="modalSub">Your visa application has been received. Save your Application ID:</p>
      <div class="app-id-box">
        <span id="modalAppId"></span>
        <button class="copy-btn" id="copyBtn" onclick="copyAppId()">ğŸ“‹ <span data-i18n="btnCopy">Copy</span></button>
      </div>
      <p style="font-size:12px;" data-i18n="modalNote">You'll need this ID to track your application status.</p>
      <button class="btn btn-primary" style="margin-top:16px;" onclick="closeModal()" data-i18n="btnDone">Done</button>
    </div>
  </div>
  
  
  
  
  
  
  
    <script>
    var currentLang="en";
    var translations={
      en:{
        loadingPortal:"Loading portal...",headerTitle:"ğŸŒ Visa Request Portal",headerSub:"Submit and track your visa application",
        navHome:"Home",navApply:"Apply",navTrack:"Track",
        heroTitle:"Welcome to Visa Services",heroSub:"Apply for your visa online with our simple, secure process.",
        featNewApp:"New Application",featNewAppDesc:"Start your visa request",
        featTrack:"Track Status",featTrackDesc:"Check your application",
        featReqs:"Requirements",featReqsDesc:"View what you need",
        featFaq:"Help & FAQ",featFaqDesc:"Get answers fast",
        importantInfo:"Important Information",
        info1:"âœ… Passport must be valid 3-6 months beyond intended stay",
        info2:"âœ… Recent passport-size photograph required",
        info3:"âœ… All mandatory fields must be completed accurately",
        info4:"âœ… Save your Application ID to track your status",
        personalInfo:"Personal Information",requiredNote:"Fields marked with",requiredNote2:"are mandatory",
        surname:"Surname",firstName:"First Name",dob:"Date of Birth",pob:"Place of Birth",
        nationality:"Current Nationality",gender:"Gender",maritalStatus:"Marital Status",
        select:"Select",male:"Male",female:"Female",other:"Other",
        single:"Single",married:"Married",divorced:"Divorced",widowed:"Widowed",
        passportDetails:"Passport Details",passportNum:"Passport Number",issuingCountry:"Issuing Country",
        dateOfIssue:"Date of Issue",expDate:"Expiration Date",
        passportWarning:"âš ï¸ Passport must be valid at least 3-6 months beyond your intended stay.",
        contactInfo:"Contact Information",homeAddress:"Home Address",email:"Email Address",telephone:"Telephone",
        purposeTitle:"Purpose & Itinerary",purpose:"Purpose of Travel",selectPurpose:"Select purpose",
        tourism:"Tourism",business:"Business",study:"Study",work:"Work",
        medical:"Medical Treatment",familyVisit:"Family Visit",transit:"Transit",otherPurpose:"Other",
        arrivalDate:"Arrival Date",departureDate:"Departure Date",destination:"Intended Destination",
        familyTitle:"Family / Reference Data",parentSpouse:"Parent/Spouse Name",
        sponsorContact:"Sponsor/Inviting Person Contact",hotelInfo:"Hotel / Accommodation Info",
        photoTitle:"Photograph",uploadPhoto:"Tap to upload a recent passport photo",photoFormat:"JPG or PNG, max 2MB",
        btnContinue:"Continue â†’",btnBack:"â† Back",btnSubmit:"Submit Application âœ“",
        trackTitle:"Track Your Application",trackSub:"Enter your Application ID to check the status",
        btnTrack:"Track Application",modalTitle:"Application Submitted!",
        modalSub:"Your visa application has been received. Save your Application ID:",
        modalNote:"You'll need this ID to track your application status.",
        btnDone:"Done",btnCopy:"Copy",btnCopied:"Copied!",
        phSurname:"Enter your surname",phFirstName:"Enter your first name",phPob:"City, Country",
        phNationality:"Enter nationality",phPassport:"Enter passport number",
        phIssuing:"Country that issued passport",phAddress:"Full home address",
        phParentSpouse:"Full name",phSponsor:"Name, address, phone/email",
        phHotel:"Hotel name, address, booking reference",phDestination:"City, Country",
        errRequired:"This field is required",errEmail:"Valid email is required",
        alertPassportExpired:"Passport has expired. Please renew before applying.",
        alertDepAfterArr:"Departure date must be after arrival date.",
        alertSubmitting:"Submitting...",alertUploading:"Uploading photo...",
        alertError:"Error: ",alertFailed:"Submission failed: ",
        alertEnterID:"Please enter an Application ID.",alertSearching:"Searching...",
        trackAppId:"Application ID",trackApplicant:"Applicant",trackSubmitted:"Submitted",trackNotes:"Notes",
        photoUploaded:"Photo uploaded âœ“",photoTapChange:"Tap to change",photoUploadFail:"Photo upload failed, try again"
      },
      ar:{
        loadingPortal:"Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©...",headerTitle:"ğŸŒ Ø¨ÙˆØ§Ø¨Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ£Ø´ÙŠØ±Ø©",headerSub:"Ù‚Ø¯Ù‘Ù… Ø·Ù„Ø¨Ùƒ ÙˆØªØªØ¨Ø¹ Ø­Ø§Ù„ØªÙ‡",
        navHome:"Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",navApply:"ØªÙ‚Ø¯ÙŠÙ…",navTrack:"ØªØªØ¨Ø¹",
        heroTitle:"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªØ£Ø´ÙŠØ±Ø©",heroSub:"Ù‚Ø¯Ù‘Ù… Ø·Ù„Ø¨ Ø§Ù„ØªØ£Ø´ÙŠØ±Ø© Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø³ÙŠØ·Ø© ÙˆØ¢Ù…Ù†Ø©.",
        featNewApp:"Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯",featNewAppDesc:"Ø§Ø¨Ø¯Ø£ Ø·Ù„Ø¨ Ø§Ù„ØªØ£Ø´ÙŠØ±Ø©",
        featTrack:"ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø§Ù„Ø©",featTrackDesc:"ØªØ­Ù‚Ù‚ Ù…Ù† Ø·Ù„Ø¨Ùƒ",
        featReqs:"Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª",featReqsDesc:"Ø§Ø·Ù‘Ù„Ø¹ Ø¹Ù„Ù‰ Ù…Ø§ ØªØ­ØªØ§Ø¬Ù‡",
        featFaq:"Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø©",featFaqDesc:"Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¥Ø¬Ø§Ø¨Ø§Øª Ø³Ø±ÙŠØ¹Ø©",
        importantInfo:"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù‡Ù…Ø©",
        info1:"âœ… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ± Ø³Ø§Ø±ÙŠ Ø§Ù„Ù…ÙØ¹ÙˆÙ„ Ù„Ù…Ø¯Ø© 3-6 Ø£Ø´Ù‡Ø± Ø¨Ø¹Ø¯ ÙØªØ±Ø© Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©",
        info2:"âœ… ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ© Ø­Ø¯ÙŠØ«Ø© Ø¨Ø­Ø¬Ù… Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ± Ù…Ø·Ù„ÙˆØ¨Ø©",
        info3:"âœ… ÙŠØ¬Ø¨ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ© Ø¨Ø¯Ù‚Ø©",
        info4:"âœ… Ø§Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ù„ØªØªØ¨Ø¹ Ø­Ø§Ù„ØªÙ‡",
        personalInfo:"Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©",requiredNote:"Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù…ÙŠØ²Ø© Ø¨Ù€",requiredNote2:"Ø¥Ù„Ø²Ø§Ù…ÙŠØ©",
        surname:"Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©",firstName:"Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„",dob:"ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯",pob:"Ù…ÙƒØ§Ù† Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯",
        nationality:"Ø§Ù„Ø¬Ù†Ø³ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©",gender:"Ø§Ù„Ø¬Ù†Ø³",maritalStatus:"Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©",
        select:"Ø§Ø®ØªØ±",male:"Ø°ÙƒØ±",female:"Ø£Ù†Ø«Ù‰",other:"Ø¢Ø®Ø±",
        single:"Ø£Ø¹Ø²Ø¨/Ø¹Ø²Ø¨Ø§Ø¡",married:"Ù…ØªØ²ÙˆØ¬/Ø©",divorced:"Ù…Ø·Ù„Ù‚/Ø©",widowed:"Ø£Ø±Ù…Ù„/Ø©",
        passportDetails:"ØªÙØ§ØµÙŠÙ„ Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±",passportNum:"Ø±Ù‚Ù… Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±",issuingCountry:"Ø¨Ù„Ø¯ Ø§Ù„Ø¥ØµØ¯Ø§Ø±",
        dateOfIssue:"ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±",expDate:"ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡",
        passportWarning:"âš ï¸ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ± Ø³Ø§Ø±ÙŠ Ø§Ù„Ù…ÙØ¹ÙˆÙ„ Ù„Ù…Ø¯Ø© 3-6 Ø£Ø´Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.",
        contactInfo:"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„",homeAddress:"Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³ÙƒÙ†",email:"Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",telephone:"Ø§Ù„Ù‡Ø§ØªÙ",
        purposeTitle:"Ø§Ù„ØºØ±Ø¶ ÙˆØ®Ø· Ø§Ù„Ø³ÙŠØ±",purpose:"ØºØ±Ø¶ Ø§Ù„Ø³ÙØ±",selectPurpose:"Ø§Ø®ØªØ± Ø§Ù„ØºØ±Ø¶",
        tourism:"Ø³ÙŠØ§Ø­Ø©",business:"Ø£Ø¹Ù…Ø§Ù„",study:"Ø¯Ø±Ø§Ø³Ø©",work:"Ø¹Ù…Ù„",
        medical:"Ø¹Ù„Ø§Ø¬ Ø·Ø¨ÙŠ",familyVisit:"Ø²ÙŠØ§Ø±Ø© Ø¹Ø§Ø¦Ù„ÙŠØ©",transit:"Ø¹Ø¨ÙˆØ±",otherPurpose:"Ø£Ø®Ø±Ù‰",
        arrivalDate:"ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØµÙˆÙ„",departureDate:"ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©",destination:"Ø§Ù„ÙˆØ¬Ù‡Ø© Ø§Ù„Ù…Ù‚ØµÙˆØ¯Ø©",
        familyTitle:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© / Ø§Ù„Ù…Ø±Ø¬Ø¹",parentSpouse:"Ø§Ø³Ù… Ø§Ù„ÙˆØ§Ù„Ø¯/Ø§Ù„Ø²ÙˆØ¬(Ø©)",
        sponsorContact:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒÙÙŠÙ„/Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…Ø¶ÙŠÙ",hotelInfo:"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙ†Ø¯Ù‚ / Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©",
        photoTitle:"Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©",uploadPhoto:"Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¬ÙˆØ§Ø² Ø³ÙØ± Ø­Ø¯ÙŠØ«Ø©",photoFormat:"JPG Ø£Ùˆ PNGØŒ Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ 2 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª",
        btnContinue:"Ù…ØªØ§Ø¨Ø¹Ø© â†",btnBack:"â†’ Ø±Ø¬ÙˆØ¹",btnSubmit:"ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ âœ“",
        trackTitle:"ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ùƒ",trackSub:"Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø©",
        btnTrack:"ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨",modalTitle:"ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨!",
        modalSub:"ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨ Ø§Ù„ØªØ£Ø´ÙŠØ±Ø©. Ø§Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:",
        modalNote:"Ø³ØªØ­ØªØ§Ø¬ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù„ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ.",
        btnDone:"ØªÙ…",btnCopy:"Ù†Ø³Ø®",btnCopied:"ØªÙ… Ø§Ù„Ù†Ø³Ø®!",
        phSurname:"Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©",phFirstName:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„",phPob:"Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©ØŒ Ø§Ù„Ø¨Ù„Ø¯",
        phNationality:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¬Ù†Ø³ÙŠØ©",phPassport:"Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±",
        phIssuing:"Ø§Ù„Ø¨Ù„Ø¯ Ø§Ù„Ù…ÙØµØ¯ÙØ± Ù„Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±",phAddress:"Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„",
        phParentSpouse:"Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„",phSponsor:"Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†ØŒ Ø§Ù„Ù‡Ø§ØªÙ/Ø§Ù„Ø¨Ø±ÙŠØ¯",
        phHotel:"Ø§Ø³Ù… Ø§Ù„ÙÙ†Ø¯Ù‚ØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†ØŒ Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²",phDestination:"Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©ØŒ Ø§Ù„Ø¨Ù„Ø¯",
        errRequired:"Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ Ù…Ø·Ù„ÙˆØ¨",errEmail:"Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ§Ù„Ø­ Ù…Ø·Ù„ÙˆØ¨",
        alertPassportExpired:"Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ± Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©. ÙŠØ±Ø¬Ù‰ ØªØ¬Ø¯ÙŠØ¯Ù‡ Ù‚Ø¨Ù„ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ….",
        alertDepAfterArr:"ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØµÙˆÙ„.",
        alertSubmitting:"Ø¬Ø§Ø±Ù Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…...",alertUploading:"Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...",
        alertError:"Ø®Ø·Ø£: ",alertFailed:"ÙØ´Ù„ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…: ",
        alertEnterID:"ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨.",alertSearching:"Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø«...",
        trackAppId:"Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨",trackApplicant:"Ù…Ù‚Ø¯Ù… Ø§Ù„Ø·Ù„Ø¨",trackSubmitted:"ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…",trackNotes:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
        photoUploaded:"ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© âœ“",photoTapChange:"Ø§Ø¶ØºØ· Ù„Ù„ØªØºÙŠÙŠØ±",photoUploadFail:"ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹"
      }
    };

    function t(k){return(translations[currentLang]&&translations[currentLang][k])||translations.en[k]||k;}

    function applyTranslations(){
      document.querySelectorAll('[data-i18n]').forEach(function(el){
        var k=el.getAttribute('data-i18n');if(translations[currentLang][k]!==undefined)el.textContent=translations[currentLang][k];
      });
      document.querySelectorAll('[data-placeholder-i18n]').forEach(function(el){
        var k=el.getAttribute('data-placeholder-i18n');if(translations[currentLang][k]!==undefined)el.placeholder=translations[currentLang][k];
      });
    }

    function toggleLang(){
      currentLang=currentLang==="en"?"ar":"en";
      var h=document.documentElement;
      if(currentLang==="ar"){h.setAttribute("dir","rtl");h.setAttribute("lang","ar");document.getElementById('langBtn').textContent="English";}
      else{h.setAttribute("dir","ltr");h.setAttribute("lang","en");document.getElementById('langBtn').textContent="Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©";}
      buildFormFromSettings();applyTranslations();
    }

    var FIELD_DEFS={
      surname:{step:1,label:"surname",type:"text",ph:"phSurname",section:"personalInfo"},
      firstName:{step:1,label:"firstName",type:"text",ph:"phFirstName",section:"personalInfo"},
      dateOfBirth:{step:1,label:"dob",type:"date",section:"personalInfo"},
      placeOfBirth:{step:1,label:"pob",type:"text",ph:"phPob",section:"personalInfo"},
      nationality:{step:1,label:"nationality",type:"text",ph:"phNationality",section:"personalInfo"},
      gender:{step:1,label:"gender",type:"select",options:[{v:"",l:"select"},{v:"Male",l:"male"},{v:"Female",l:"female"},{v:"Other",l:"other"}],section:"personalInfo"},
      maritalStatus:{step:1,label:"maritalStatus",type:"select",options:[{v:"",l:"select"},{v:"Single",l:"single"},{v:"Married",l:"married"},{v:"Divorced",l:"divorced"},{v:"Widowed",l:"widowed"}],section:"personalInfo"},
      passportNumber:{step:2,label:"passportNum",type:"text",ph:"phPassport",section:"passportDetails"},
      issuingCountry:{step:2,label:"issuingCountry",type:"text",ph:"phIssuing",section:"passportDetails"},
      dateOfIssue:{step:2,label:"dateOfIssue",type:"date",section:"passportDetails"},
      expirationDate:{step:2,label:"expDate",type:"date",section:"passportDetails"},
      homeAddress:{step:3,label:"homeAddress",type:"textarea",ph:"phAddress",section:"contactInfo"},
      email:{step:3,label:"email",type:"email",section:"contactInfo"},
      telephone:{step:3,label:"telephone",type:"tel",section:"contactInfo"},
      purposeOfTravel:{step:4,label:"purpose",type:"select",options:[{v:"",l:"selectPurpose"},{v:"Tourism",l:"tourism"},{v:"Business",l:"business"},{v:"Study",l:"study"},{v:"Work",l:"work"},{v:"Medical",l:"medical"},{v:"Family Visit",l:"familyVisit"},{v:"Transit",l:"transit"},{v:"Other",l:"otherPurpose"}],section:"purposeTitle"},
      arrivalDate:{step:4,label:"arrivalDate",type:"date",section:"purposeTitle"},
      departureDate:{step:4,label:"departureDate",type:"date",section:"purposeTitle"},
      destination:{step:4,label:"destination",type:"text",ph:"phDestination",section:"purposeTitle"},
      parentSpouseName:{step:5,label:"parentSpouse",type:"text",ph:"phParentSpouse",section:"familyTitle"},
      sponsorContact:{step:5,label:"sponsorContact",type:"textarea",ph:"phSponsor",section:"familyTitle"},
      hotelInfo:{step:5,label:"hotelInfo",type:"textarea",ph:"phHotel",section:"familyTitle"},
      photo:{step:5,label:"photoTitle",type:"photo",section:"photoTitle"}
    };

    var STEP_ICONS={1:"ğŸ‘¤",2:"ğŸ“˜",3:"ğŸ“",4:"ğŸ—ºï¸",5:"ğŸ‘¨â€ğŸ‘©â€ğŸ‘§"};
    var STEP_SECTIONS={1:"personalInfo",2:"passportDetails",3:"contactInfo",4:"purposeTitle",5:"familyTitle"};
    var fieldSettings=[];var activeSteps=[];var currentStep=0;

    // Photo state
    var photoBase64="";
    var photoFileId="";
    var photoUploading=false;

    function buildFormFromSettings(){
      var c=document.getElementById('formStepsContainer');c.innerHTML='';
      var map={};for(var i=0;i<fieldSettings.length;i++)map[fieldSettings[i].id]=fieldSettings[i];
      var sc={},sh={};
      for(var fid in FIELD_DEFS){var d=FIELD_DEFS[fid];var cfg=map[fid];if(!cfg||!cfg.visible)continue;var s=d.step;if(!sc[s]){sc[s]=[];sh[s]=true;}sc[s].push({id:fid,def:d,required:cfg.required});}
      activeSteps=[];for(var s=1;s<=5;s++)if(sh[s])activeSteps.push(s);
      var ih='';for(var si=0;si<activeSteps.length;si++){ih+='<div class="step-dot'+(si===0?' active':'')+'" data-step-index="'+si+'"></div>';}
      document.getElementById('stepIndicators').innerHTML=ih;
      for(var si2=0;si2<activeSteps.length;si2++){
        var sn=activeSteps[si2];var fields=sc[sn];var sk=STEP_SECTIONS[sn];var ico=STEP_ICONS[sn];
        var isF=si2===0;var isL=si2===activeSteps.length-1;
        var hr=fields.some(function(f){return f.required;});
        var h='<div class="form-step" data-step-index="'+si2+'" style="'+(si2>0?'display:none;':'')+'">';
        h+='<div class="card"><div class="card-title"><div class="icon">'+ico+'</div> <span data-i18n="'+sk+'">'+t(sk)+'</span></div>';
        if(hr)h+='<p class="required-note"><span data-i18n="requiredNote">'+t('requiredNote')+'</span> <span class="required">*</span> <span data-i18n="requiredNote2">'+t('requiredNote2')+'</span></p>';
        for(var fi=0;fi<fields.length;fi++)h+=buildFieldHtml(fields[fi].id,fields[fi].def,fields[fi].required);
        if(sn===2)h+='<div class="alert alert-info"><span data-i18n="passportWarning">'+t('passportWarning')+'</span></div>';
        h+='</div><div class="btn-row">';
        if(!isF)h+='<button type="button" class="btn btn-outline" onclick="prevStep()" data-i18n="btnBack">'+t('btnBack')+'</button>';
        if(isL)h+='<button type="button" class="btn btn-primary" id="submitBtn" onclick="submitForm()"><span data-i18n="btnSubmit">'+t('btnSubmit')+'</span></button>';
        else h+='<button type="button" class="btn btn-primary" onclick="nextStep()" data-i18n="btnContinue">'+t('btnContinue')+'</button>';
        h+='</div></div>';
        c.insertAdjacentHTML('beforeend',h);
      }
      currentStep=0;
    }

    function buildFieldHtml(id,def,req){
      var lbl=t(def.label);var ph=def.ph?t(def.ph):'';var rs=req?'<span class="required">*</span>':'';
      var pa=def.ph?' data-placeholder-i18n="'+def.ph+'" placeholder="'+ph+'"':'';var h='';
      if(def.type==='photo'){
        h+='<div class="form-group" data-field="'+id+'">';
        h+='<div class="card-title" style="margin-top:16px;"><div class="icon">ğŸ“·</div> <span data-i18n="photoTitle">'+t('photoTitle')+'</span></div>';
        h+='<div class="photo-upload" id="photoUpload" onclick="document.getElementById(\'photoInput\').click()">';
        h+='<div style="font-size:32px;margin-bottom:8px;">ğŸ“¸</div>';
        h+='<div class="upload-text" data-i18n="uploadPhoto">'+t('uploadPhoto')+'</div>';
        h+='<div style="font-size:12px;color:var(--gray-500);margin-top:4px;" data-i18n="photoFormat">'+t('photoFormat')+'</div>';
        h+='</div><input type="file" id="photoInput" accept="image/*" style="display:none" onchange="handlePhoto(this)"></div>';
        return h;
      }
      h+='<div class="form-group" data-field="'+id+'"><label><span data-i18n="'+def.label+'">'+lbl+'</span> '+rs+'</label>';
      if(def.type==='select'){
        h+='<select id="'+id+'"'+(req?' data-required="true"':'')+'>';
        for(var oi=0;oi<def.options.length;oi++){var o=def.options[oi];h+='<option value="'+o.v+'" data-i18n="'+o.l+'">'+t(o.l)+'</option>';}
        h+='</select>';
      }else if(def.type==='textarea'){
        h+='<textarea id="'+id+'" rows="3"'+pa+(req?' data-required="true"':'')+'></textarea>';
      }else{
        h+='<input type="'+def.type+'" id="'+id+'"'+pa+(req?' data-required="true"':'')+'>';
      }
      h+='<div class="error-msg" id="err-'+id+'" data-i18n="errRequired">'+t('errRequired')+'</div></div>';
      return h;
    }

    function getCurrentStepEl(){return document.querySelector('.form-step[data-step-index="'+currentStep+'"]');}

    function showStep(idx){
      document.querySelectorAll('.form-step').forEach(function(el){el.style.display='none';});
      var el=document.querySelector('.form-step[data-step-index="'+idx+'"]');
      if(el)el.style.display='block';
      currentStep=idx;
      document.querySelectorAll('.step-dot').forEach(function(d,i){
        d.classList.remove('active','completed');
        if(i===currentStep)d.classList.add('active');else if(i<currentStep)d.classList.add('completed');
      });
      window.scrollTo(0,0);
    }

    function validateCurrentStep(){
      var stepEl=getCurrentStepEl();if(!stepEl)return true;var valid=true;
      stepEl.querySelectorAll('[data-required="true"]').forEach(function(el){
        var err=document.getElementById('err-'+el.id);
        if(!el.value||!el.value.trim()){el.classList.add('error');if(err)err.classList.add('show');valid=false;}
        else{el.classList.remove('error');if(err)err.classList.remove('show');}
      });
      var emailEl=stepEl.querySelector('#email[data-required="true"]');
      if(emailEl&&emailEl.value&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailEl.value)){
        emailEl.classList.add('error');var e=document.getElementById('err-email');
        if(e){e.textContent=t('errEmail');e.classList.add('show');}valid=false;
      }
      var expEl=stepEl.querySelector('#expirationDate');
      if(expEl&&expEl.value&&new Date(expEl.value)<new Date()){expEl.classList.add('error');showAlert(t('alertPassportExpired'),'error');valid=false;}
      var arrEl=stepEl.querySelector('#arrivalDate');var depEl=stepEl.querySelector('#departureDate');
      if(arrEl&&depEl&&arrEl.value&&depEl.value&&new Date(depEl.value)<=new Date(arrEl.value)){depEl.classList.add('error');showAlert(t('alertDepAfterArr'),'error');valid=false;}
      return valid;
    }

    function nextStep(){if(validateCurrentStep())showStep(currentStep+1);}
    function prevStep(){showStep(currentStep-1);}

    function showAlert(msg,type){
      var d=document.getElementById('formAlert');
      d.innerHTML='<div class="alert alert-'+type+'">'+msg+'</div>';
      setTimeout(function(){d.innerHTML='';},5000);
    }

    /* ============ PHOTO HANDLING ============ */
    
    
        function handlePhoto(input){
      var file=input.files[0];
      if(!file)return;
      if(file.size>5*1024*1024){alert("Max 5MB");input.value="";return;}

      var upload=document.getElementById('photoUpload');
      photoUploading=true;

      if(upload){
        upload.innerHTML='<div class="spinner" style="border:4px solid var(--gray-200);border-top-color:var(--primary);width:36px;height:36px;"></div>'+
          '<div style="margin-top:10px;font-size:14px;color:var(--gray-500);">'+t('alertUploading')+'</div>';
      }

      // Resize image before uploading to keep base64 small
      compressImage(file, 800, 0.7, function(compressedBase64){
        photoBase64=compressedBase64;

        console.log("Compressed base64 length: "+compressedBase64.length);

        var fileName="visa_"+Date.now()+".jpg";

        google.script.run
          .withSuccessHandler(function(result){
            photoUploading=false;
            console.log("Server response:", JSON.stringify(result));

            if(result && result.success){
              photoFileId=result.fileId;
              if(upload){
                upload.classList.add('has-photo');
                upload.innerHTML='<img src="'+compressedBase64+'" style="max-width:120px;max-height:150px;border-radius:8px;margin-bottom:8px;">'+
                  '<div class="upload-text" style="color:#059669;">'+t('photoUploaded')+'</div>'+
                  '<div style="font-size:12px;color:var(--gray-500);margin-top:4px;">'+t('photoTapChange')+'</div>';
              }
            }else{
              var errMsg=result?result.error:"No response";
              console.error("Upload failed: "+errMsg);
              photoFileId="";
              if(upload){
                upload.classList.add('has-photo');
                upload.innerHTML='<img src="'+compressedBase64+'" style="max-width:100px;max-height:120px;border-radius:8px;">'+
                  '<div class="upload-text" style="color:var(--warning);font-size:13px;margin-top:8px;">âš ï¸ '+errMsg+'</div>'+
                  '<div style="font-size:11px;color:var(--gray-500);margin-top:4px;">Photo will be uploaded on submit</div>';
              }
            }
          })
          .withFailureHandler(function(err){
            photoUploading=false;
            var errMsg=err.message||err.toString();
            console.error("Upload exception: "+errMsg);
            photoFileId="";
            if(upload){
              upload.classList.add('has-photo');
              upload.innerHTML='<img src="'+compressedBase64+'" style="max-width:100px;max-height:120px;border-radius:8px;">'+
                '<div class="upload-text" style="color:var(--warning);font-size:13px;margin-top:8px;">âš ï¸ '+errMsg+'</div>'+
                '<div style="font-size:11px;color:var(--gray-500);margin-top:4px;">Photo will be uploaded on submit</div>';
            }
          })
          .uploadPhotoToDrive(compressedBase64, fileName);
      });
    }

    function compressImage(file, maxSize, quality, callback){
      var reader=new FileReader();
      reader.onload=function(e){
        var img=new Image();
        img.onload=function(){
          var canvas=document.createElement('canvas');
          var w=img.width;
          var h=img.height;

          // Scale down if larger than maxSize
          if(w>maxSize||h>maxSize){
            if(w>h){h=Math.round(h*maxSize/w);w=maxSize;}
            else{w=Math.round(w*maxSize/h);h=maxSize;}
          }

          canvas.width=w;
          canvas.height=h;
          var ctx=canvas.getContext('2d');
          ctx.drawImage(img,0,0,w,h);

          var compressed=canvas.toDataURL('image/jpeg',quality);
          console.log("Original size: "+file.size+" bytes, Compressed base64: "+compressed.length+" chars");
          callback(compressed);
        };
        img.onerror=function(){
          // If image can't be loaded into canvas, use raw base64
          console.warn("Canvas compression failed, using raw base64");
          callback(e.target.result);
        };
        img.src=e.target.result;
      };
      reader.onerror=function(){
        alert("Error reading file");
        photoUploading=false;
        resetPhotoUpload();
      };
      reader.readAsDataURL(file);
    }
    
    function resetPhotoUpload(){
      var upload=document.getElementById('photoUpload');
      if(upload){
        upload.classList.remove('has-photo');
        upload.innerHTML='<div style="font-size:32px;margin-bottom:8px;">ğŸ“¸</div>'+
          '<div class="upload-text" data-i18n="uploadPhoto">'+t('uploadPhoto')+'</div>'+
          '<div style="font-size:12px;color:var(--gray-500);margin-top:4px;" data-i18n="photoFormat">'+t('photoFormat')+'</div>';
      }
      photoBase64="";
      photoFileId="";
      photoUploading=false;
    }

    /* ============ SUBMIT ============ */
    function submitForm(){
      if(!validateCurrentStep())return;

      // Prevent submit while photo is still uploading
      if(photoUploading){
        showAlert(t('alertUploading'),'info');
        return;
      }

      var btn=document.getElementById('submitBtn');
      btn.disabled=true;
      btn.innerHTML='<span class="spinner"></span> '+t('alertSubmitting');

      var data={};
      ['surname','firstName','dateOfBirth','placeOfBirth','nationality','gender','maritalStatus',
       'passportNumber','issuingCountry','dateOfIssue','expirationDate','homeAddress','email','telephone',
       'purposeOfTravel','arrivalDate','departureDate','destination','parentSpouseName','sponsorContact','hotelInfo'
      ].forEach(function(fid){var el=document.getElementById(fid);data[fid]=el?el.value.trim():"";});

      // Send Drive file ID if available, otherwise send base64 as fallback
      data.photoFileId=photoFileId||"";
      data.photoBase64=(photoFileId?"":photoBase64)||"";

      console.log("Submitting with photoFileId: ["+data.photoFileId+"] photoBase64 length: "+data.photoBase64.length);

      google.script.run
        .withSuccessHandler(function(r){
          btn.disabled=false;
          btn.innerHTML='<span data-i18n="btnSubmit">'+t('btnSubmit')+'</span>';
          if(r.success){
            document.getElementById('modalAppId').textContent=r.applicationId;
            document.getElementById('copyBtn').classList.remove('copied');
            var cs=document.querySelector('#copyBtn span');if(cs)cs.textContent=t('btnCopy');
            document.getElementById('successModal').classList.add('show');
            document.getElementById('visaForm').reset();
            resetPhotoUpload();
            showStep(0);
          }else{
            showAlert(t('alertError')+r.error,'error');
          }
        })
        .withFailureHandler(function(e){
          btn.disabled=false;
          btn.innerHTML='<span data-i18n="btnSubmit">'+t('btnSubmit')+'</span>';
          showAlert(t('alertFailed')+e.message,'error');
        })
        .submitApplication(data);
    }

    /* ============ COPY ============ */
    function copyAppId(){
      var id=document.getElementById('modalAppId').textContent;if(!id)return;
      if(navigator.clipboard&&navigator.clipboard.writeText){
        navigator.clipboard.writeText(id).then(function(){showCopied();}).catch(function(){fallbackCopy(id);});
      }else fallbackCopy(id);
    }

    function fallbackCopy(text){
      var ta=document.createElement('textarea');ta.value=text;ta.style.position='fixed';ta.style.left='-9999px';
      document.body.appendChild(ta);ta.select();
      try{document.execCommand('copy');showCopied();}catch(e){alert('Copy: '+text);}
      document.body.removeChild(ta);
    }

    function showCopied(){
      var b=document.getElementById('copyBtn');b.classList.add('copied');var s=b.querySelector('span');
      if(s)s.textContent=t('btnCopied');
      setTimeout(function(){b.classList.remove('copied');if(s)s.textContent=t('btnCopy');},2000);
    }

    function closeModal(){document.getElementById('successModal').classList.remove('show');}

    function showSection(section){
      document.querySelectorAll('.section').forEach(function(s){s.classList.remove('active');});
      document.querySelectorAll('.nav-tab').forEach(function(t){t.classList.remove('active');});
      document.getElementById('section-'+section).classList.add('active');
      var tabs={'home':0,'apply':1,'track':2};
      document.querySelectorAll('.nav-tab')[tabs[section]].classList.add('active');
      window.scrollTo(0,0);
    }

    function trackApp(){
      var id=document.getElementById('trackId').value.trim();
      if(!id){document.getElementById('trackResult').innerHTML='<div class="alert alert-error" style="margin-top:16px;">'+t('alertEnterID')+'</div>';return;}
      document.getElementById('trackResult').innerHTML='<div style="margin-top:16px;text-align:center;color:var(--gray-500);">'+t('alertSearching')+'</div>';
      google.script.run
        .withSuccessHandler(function(r){
          if(r.success){var a=r.application;var sc='status-'+a.status.replace(/\s+/g,'-');
            document.getElementById('trackResult').innerHTML='<div class="track-result"><div style="text-align:center;margin-bottom:16px;"><span class="status-badge '+sc+'">'+a.status+'</span></div>'+
            '<div class="info-row"><span class="info-label">'+t('trackAppId')+'</span><span class="info-value">'+a.applicationId+'</span></div>'+
            '<div class="info-row"><span class="info-label">'+t('trackApplicant')+'</span><span class="info-value">'+a.firstName+' '+a.surname+'</span></div>'+
            '<div class="info-row"><span class="info-label">'+t('trackSubmitted')+'</span><span class="info-value">'+a.submissionDate+'</span></div>'+
            (a.adminNotes?'<div class="info-row"><span class="info-label">'+t('trackNotes')+'</span><span class="info-value">'+a.adminNotes+'</span></div>':'')+'</div>';
          }else document.getElementById('trackResult').innerHTML='<div class="alert alert-error" style="margin-top:16px;">'+r.error+'</div>';
        })
        .withFailureHandler(function(e){document.getElementById('trackResult').innerHTML='<div class="alert alert-error" style="margin-top:16px;">'+t('alertError')+e.message+'</div>';})
        .trackApplication(id);
    }

    /* ============ INIT ============ */
    google.script.run
      .withSuccessHandler(function(s){
        fieldSettings=s||[];buildFormFromSettings();applyTranslations();
        document.getElementById('loadingScreen').classList.remove('show');document.getElementById('mainApp').style.display='block';
      })
      .withFailureHandler(function(e){
        fieldSettings=[
          {id:"surname",visible:true,required:true},{id:"firstName",visible:true,required:true},
          {id:"dateOfBirth",visible:true,required:true},{id:"placeOfBirth",visible:true,required:true},
          {id:"nationality",visible:true,required:true},{id:"gender",visible:true,required:true},
          {id:"maritalStatus",visible:true,required:true},{id:"passportNumber",visible:true,required:true},
          {id:"issuingCountry",visible:true,required:true},{id:"dateOfIssue",visible:true,required:true},
          {id:"expirationDate",visible:true,required:true},{id:"homeAddress",visible:true,required:true},
          {id:"email",visible:true,required:true},{id:"telephone",visible:true,required:true},
          {id:"purposeOfTravel",visible:true,required:true},{id:"arrivalDate",visible:true,required:true},
          {id:"departureDate",visible:true,required:true},{id:"destination",visible:true,required:true},
          {id:"parentSpouseName",visible:true,required:false},{id:"sponsorContact",visible:true,required:false},
          {id:"hotelInfo",visible:true,required:false},{id:"photo",visible:true,required:false}
        ];
        buildFormFromSettings();applyTranslations();
        document.getElementById('loadingScreen').classList.remove('show');document.getElementById('mainApp').style.display='block';
      })
      .getFieldSettings();

function goToLanding() {
  document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#0f172a;color:#fff;font-size:16px;">Returning home...</div>';
  google.script.run
    .withSuccessHandler(function(html) {
      document.open();
      document.write(html);
      document.close();
    })
    .withFailureHandler(function() {
      // Fallback: reload the page which goes to landing by default
      window.location.reload();
    })
    .getPageContent('landing');
}

// Handle mobile back button
history.pushState(null, '', location.href);
window.addEventListener('popstate', function(e) {
  history.pushState(null, '', location.href);
  goToLanding();
});
</script>
  
  
</body>
</html>

